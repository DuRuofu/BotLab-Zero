# 差速小车仿真与控制

## 一、简介

本部分我们主要尝试完成这些部分：

1. 研究四轮差速小车的运动学原理
2. 使用URDF来搭建一个基础的四轮差速小车
3.  配置 Gazebo 仿真环境，加载小车模型到仿真环境
4. 为小车添加控制功能，实现小车的运动控制（使用键盘控制）

---

## 二、差速小车运动学建模

四轮差速（4WD Differential Drive）是一种常见的移动机器人运动控制方式。 与阿克曼转向不同，四轮差速小车的四个轮子均固定方向，无法单独转向。小车的前进、后退和转向完全依靠 **左右两侧车轮的速度差** 来实现。这使得它的控制比较简单，下面我们尝试去建立一个四轮差速小车的运动学模型：

![542](attachments/Pasted%20image%2020251021215521.png)

### 基本运动原理：

- **直行**：左右两侧车轮转速相同，方向相同。  
- **转弯**：左右两侧车轮转速不同。  
  - 左转：右轮转速 > 左轮转速  
  - 右转：左轮转速 > 右轮转速  
- **原地旋转**：左右两侧车轮反向旋转，速度相同。

### 运动学模型：

首先，我们要如何表示小车的当前状态，可以从两个角度出发：

- **小车当前机体位姿**：$p=(x,y,θ)$ ,其中其中 $(x,y)$为质心在全局坐标系的位置，$θ$为车头相对于全局$𝑥$轴的航向角（弧度），右手系，逆时针为正。
- **小车当前速度**：
     - $v$: 车体线速度（m/s），正为车头朝向前进方向。
     - $ω$：车体角速度（rad/s），正为逆时针旋转。

![499](attachments/Pasted%20image%2020251021221122.png)

而在实际的控制系统里，我们可以得到的一手数据是什么，主要是四个轮子的转速（通过正交编码器测量）。

所谓的运动学模型，就是我们通过已知的四个轮速和车辆参数去计算前面提到的两个可以用于表达小车状态的参数。或者反过来，基于一个理想的小车状态参数，去反向推算小车的四个轮子该是什么速度，以实现我们对小车的控制。

#### 1. 符号约定

我们可以约定一些基本的表达：

|                     符号                      |          含义          | 说明                                      |
| :-----------------------------------------: | :------------------: | :-------------------------------------- |
|              $p=(x,y,\theta)$               |     小车在全局坐标系下的位姿     | $x,y$：质心位置，$\theta$：车头朝向角（弧度），右手系，逆时针为正 |
|                     $v$                     |      车体线速度（m/s）      | 沿车头方向，正为前进                              |
|                  $\omega$                   |     车体角速度（rad/s）     | 绕质心逆时针为正                                |
|                     $L$                     |     左右轮中心线间距（m）      | 即车体宽度                                   |
|                     $R$                     |       车轮半径（m）        | 将电机角速度换算为轮缘线速度用                         |
|                      A                      | 前左轮（Front Left, FL）  | 电机编号 A                                  |
|                      B                      | 前右轮（Front Right, FR） | 电机编号 B                                  |
|                      C                      |  后左轮（Rear Left, RL）  | 电机编号 C                                  |
|                      D                      | 后右轮（Rear Right, RR）  | 电机编号 D                                  |
| $\omega_A,\ \omega_B,\ \omega_C,\ \omega_D$ |    各电机角速度（rad/s）     | 从编码器或驱动器读取；注意各电机方向符号需统一定义               |


#### 2. 从电机角速度到侧向速度

我们通过编码器可以测量出每个轮子的角速度，在已知轮子半径的情况下，可以求得每轮线速度：
$$
v_i = R \cdot \omega_i,\quad i\in\{A,B,C,D\}
$$

四个轮子太多，我们简化为左右侧速度定义，同侧轮子速度取均值：
$$
V_L = \frac{v_A + v_C}{2} = \frac{R(\omega_A + \omega_C)}{2}
$$
$$
V_R = \frac{v_B + v_D}{2} = \frac{R(\omega_B + \omega_D)}{2}
$$

矩阵（从 $\boldsymbol{\omega}=[\omega_A,\omega_B,\omega_C,\omega_D]^\top$ 到 $[V_L,V_R]^\top$）：
$$
\begin{bmatrix} V_L \\[4pt] V_R \end{bmatrix}
=
\frac{R}{2}
\begin{bmatrix}
1 & 0 & 1 & 0 \\
0 & 1 & 0 & 1
\end{bmatrix}
\begin{bmatrix}\omega_A\\\omega_B\\\omega_C\\\omega_D\end{bmatrix}
$$
#### 3. 从左右侧速度到车体速度


对于差速小车来说，左右两侧轮子行驶的距离不同会导致车辆绕着一个瞬时旋转中心转动。

设车辆两侧轮的线速度分别为 $V_L$、$V_R$，左右轮间距为 $L$，则在短时间 $\Delta t$ 内：

- 左右轮行驶的弧长分别为 $V_L \Delta t$、$V_R \Delta t$；
- 它们绕同一圆心转动，因此角速度满足：
  $$
  \omega = \frac{\text{右侧线速度} - \text{左侧线速度}}{\text{轮距}} = \frac{V_R - V_L}{L}
  $$
该式反映了：当右轮比左轮快时（$V_R > V_L$），车辆逆时针旋转（$\omega>0$）。

同时，车体的线速度取左右两侧线速度的平均：
$$
v = \frac{V_L + V_R}{2}
$$

将上式写成矩阵形式：
$$
\begin{bmatrix}
v \\[6pt]
\omega
\end{bmatrix}
=
\begin{bmatrix}
\frac{1}{2} & \frac{1}{2} \\[6pt]
-\frac{1}{L} & \frac{1}{L}
\end{bmatrix}
\begin{bmatrix}
V_L \\[4pt]
V_R
\end{bmatrix}
$$

该形式简洁且清晰地表明了四轮差速车的运行模型：  

- 第一行是**平均**（取左右平均得线速度）  
- 第二行是**差分**（取左右差除以轮距得角速度）

结合第二部分，若已知四个轮子的角速度 $\omega_A,\omega_B,\omega_C,\omega_D$，结合
$$
V_L = \frac{R(\omega_A + \omega_C)}{2},\quad V_R = \frac{R(\omega_B + \omega_D)}{2}
$$

可将上面的关系写为完整矩阵形式：
$$
\begin{bmatrix}
v \\[6pt]
\omega
\end{bmatrix}
=
\frac{R}{4}
\begin{bmatrix}
1 & 1 & 1 & 1 \\[6pt]
-\tfrac{2}{L} & \tfrac{2}{L} & -\tfrac{2}{L} & \tfrac{2}{L}
\end{bmatrix}
\begin{bmatrix}
\omega_A \\[4pt]
\omega_B \\[4pt]
\omega_C \\[4pt]
\omega_D
\end{bmatrix}
$$

即：
$$
v = \frac{R}{4}(\omega_A + \omega_B + \omega_C + \omega_D)
$$
$$
\omega = \frac{R}{2L}(\omega_B + \omega_D - \omega_A - \omega_C)
$$

这就是最终的**四轮角速度到车体线速度与角速度的线性映射关系**

#### 4. 逆运算：由车体速度求四轮角速度

先求左右侧线速度

给定期望的车体线速度 $v$ 和角速度 $\omega$，先求左右侧线速度 $V_L,V_R$：
$$
V_L = v - \frac{\omega L}{2},\qquad
V_R = v + \frac{\omega L}{2}
$$

矩阵形式：
$$
\begin{bmatrix}
V_L \\[4pt]
V_R
\end{bmatrix}
=
\begin{bmatrix}
1 & -\tfrac{L}{2} \\[4pt]
1 & \tfrac{L}{2}
\end{bmatrix}
\begin{bmatrix}
v \\[4pt]
\omega
\end{bmatrix}
$$


若前后同侧轮速度取均值（即前后同步），则对应的轮缘线速度为：
$$
v_A = v_C = V_L,\qquad v_B = v_D = V_R
$$
由此得到电机角速度：
$$
\omega_A = \omega_C = \frac{V_L}{R},\qquad
\omega_B = \omega_D = \frac{V_R}{R}
$$

合并写成矩阵形式（从 $[v,\omega]^\top$ 到 $\boldsymbol{\omega}=[\omega_A,\omega_B,\omega_C,\omega_D]^\top$）：
$$
\begin{bmatrix}
\omega_A \\[4pt]
\omega_B \\[4pt]
\omega_C \\[4pt]
\omega_D
\end{bmatrix}
=
\frac{1}{R}
\begin{bmatrix}
1 & -\tfrac{L}{2} \\[4pt]
1 & \tfrac{L}{2} \\[4pt]
1 & -\tfrac{L}{2} \\[4pt]
1 & \tfrac{L}{2}
\end{bmatrix}
\begin{bmatrix}
v \\[4pt]
\omega
\end{bmatrix}
$$
> 注意：
> - 以上分配假定前后同侧轮速度相等，适用于刚性车体且驱动/减速比相同时的常见实现。  
> - 若需要四轮独立控制（前后可不同），可把 $V_L,V_R$ 作为约束，再根据策略（如最小二乘或优先保持某一轮饱和约束）分配四个轮速；数学上可用伪逆或线性规划求解受限分配。
> - 在实际控制里对计算得到的 $\omega_i$ 需做限幅、加速度限制与滤波，避免驱动器饱和或机械冲击。

---

#### 5. 姿态的计算（里程计 / Odometry）

##### 5.1 连续微分关系（运动学方程）

车体位姿 $(x,y,\theta)$ 满足：
$$
\frac{dx}{dt} = v\cos\theta,\quad
\frac{dy}{dt} = v\sin\theta,\quad
\frac{d\theta}{dt} = \omega
$$

##### 5.2 离散欧拉近似（采样周期 $\Delta t$）

控制循环常用的简单积分：
$$
x_{k+1} = x_k + v_k\cos\theta_k\;\Delta t
$$
$$
y_{k+1} = y_k + v_k\sin\theta_k\;\Delta t
$$
$$
\theta_{k+1} = \theta_k + \omega_k\;\Delta t
$$

优点：实现简单，计算量小。缺点：当角速度较大或采样周期较长时误差较大。

## 四、URDF 文件编写


URDF（Unified Robot Description Format）是一种用于描述机器人结构、关节和惯量的 XML 格式，广泛用于 ROS 系统。 
通过 URDF，可以在 Gazebo、RViz 中可视化和仿真小车，验证我们之前推导的运动学模型。

### 4.1 小车结构规划

假设我们的小车为标准四轮差速车：

- **底盘**（chassis）：刚性体，挂载四个轮子。
- **轮子**（wheel）：前后左右各一个。
- **轮距和轴距**：  
  - 左右轮距 $L$  
  - 前后轮距 $W$（轴距）  

结构图示：

```
  FL      FR
  O------O
  |      |
  |      |
  O------O
  RL      RR

```

### 4.2 URDF 文件示例

```

### 4.2 URDF 文件示例

```xml
<?xml version="1.0"?>
<robot name="diff_drive_car">

  <!-- 底盘 -->
  <link name="base_link">
    <visual>
      <geometry>
        <box size="0.5 0.3 0.1"/>
      </geometry>
      <material name="blue"/>
    </visual>
    <collision>
      <geometry>
        <box size="0.5 0.3 0.1"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="5.0"/>
      <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1"/>
    </inertial>
  </link>

  <!-- 前左轮 FL -->
  <link name="wheel_fl"/>
  <joint name="joint_fl" type="continuous">
    <parent link="base_link"/>
    <child link="wheel_fl"/>
    <origin xyz="0.25 0.15 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- 前右轮 FR -->
  <link name="wheel_fr"/>
  <joint name="joint_fr" type="continuous">
    <parent link="base_link"/>
    <child link="wheel_fr"/>
    <origin xyz="0.25 -0.15 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- 后左轮 RL -->
  <link name="wheel_rl"/>
  <joint name="joint_rl" type="continuous">
    <parent link="base_link"/>
    <child link="wheel_rl"/>
    <origin xyz="-0.25 0.15 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- 后右轮 RR -->
  <link name="wheel_rr"/>
  <joint name="joint_rr" type="continuous">
    <parent link="base_link"/>
    <child link="wheel_rr"/>
    <origin xyz="-0.25 -0.15 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
  </joint>

</robot>

```


---

## 五、Gazebo 仿真配置

1. 创建 Gazebo world 文件
2. 将 URDF 与 Gazebo 集成（`xacro` 与 `gazebo_ros` 插件）
3. 启动仿真环境
4. 调整物理参数（摩擦力、质量、惯量等）
5. 使用 `ros2 topic` 检查小车状态

---

## 六、运动控制算法实现

1. 差速运动控制公式
2. 发布速度指令 (`geometry_msgs/msg/Twist`)
3. 简单前进、后退、旋转控制
4. 基于键盘或脚本控制小车

---

## 七、键盘控制实现

1. 使用 `turtle_teleop_key` 或自定义键盘节点
2. 节点订阅 `cmd_vel` 话题
3. 键盘映射到速度指令
4. 调试与运行注意事项

---

## 八、仿真测试与调试

1. 检查小车运动是否符合预期
2. 调整速度和转向参数
3. 常见问题排查

   * URDF 模型偏移
   * Gazebo 物理参数导致的不稳定
   * 话题未发布或未订阅
4. 使用 `rqt_graph` 与 `ros2 topic echo` 调试

---



## 参考文献

1. 